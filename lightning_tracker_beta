blueprint:
  name: Blitz-LightningTracker
  description: 'Send a notification with map when lightning strikes within a specified
    distance.

    Designed specifically for the Blitzortung Lightning Detector integration.

    Includes strike location, direction, and interactive map view.

    '
  domain: automation
  source_url: https://github.com/zacharyd3/Blitz-LightningTracker/blob/main/lightning_tracker.yaml
  input:
    notification_title:
      name: Notification Title
      description: Title for the notification
      default: Lightning Strike Nearby!
      selector:
        text: {}
    max_distance:
      name: Maximum Distance (km)
      description: Maximum distance in kilometers to trigger notification
      default: 7.5
      selector:
        number:
          min: 1.0
          max: 50.0
          step: 0.25
          unit_of_measurement: km
          mode: slider
    lightning_distance_sensor:
      name: Lightning Distance Sensor
      description: Blitzortung distance sensor (usually ends with '_distance')
      selector:
        entity:
          integration: blitzortung
          multiple: false
    lightning_area_sensor:
      name: Lightning Area Sensor
      description: Blitzortung area sensor (usually ends with '_area')
      selector:
        entity:
          integration: blitzortung
          multiple: false
    notify_device:
      name: Mobile Device
      description: Select a phone or tablet with the mobile app installed
      selector:
        device:
          integration: mobile_app
          multiple: false
    advanced:
      name: Additional options
      icon: mdi:cog
      description: Configure optional Features
      collapsed: true
      input:
        notification_channel:
          name: Notification Channel
          description: Notification channel for Android's notification system
          default: ''
          selector:
            text:
              type: text
              multiple: false
              multiline: false
        notification_timeout:
          name: Notification Timeout (minutes)
          description: Time before Android automatically clears the notification
          default: 10
          selector:
            number:
              min: 1.0
              max: 120.0
              step: 1.0
              unit_of_measurement: minutes
              mode: slider
        google_maps_api_key:
          name: Google Maps API Key
          description: 'Your Google Maps Static API key for map images.

            Get one at: https://console.cloud.google.com/apis/credentials

            Leave empty to disable map images.

            '
          default: ''
          selector:
            text:
              type: password
              multiple: false
              multiline: false
        include_map_image:
          name: Include Map Image
          description: Include a static map image in the notification (requires API
            key)
          default: false
          selector:
            boolean: {}
        show_device_location:
          name: Show Device Location on Map
          description: Show your device's location as a blue pin on the map image
          default: true
          selector:
            boolean: {}
        only_notify_closer_strikes:
          name: Only Notify for Closer Strikes
          description: Only send notifications when lightning strikes are getting
            closer than the last notification
          default: false
          selector:
            boolean: {}
        cooldown_minutes:
          name: Cooldown Period (minutes)
          description: Minimum time between notifications to avoid spam. The minimum
            is 0.5 min. due to trying to keep within the rate limit of openstreetmaps.
          default: 1.5
          selector:
            number:
              min: 0.5
              max: 10.0
              step: 0.5
              unit_of_measurement: minutes
              mode: slider
alias: âš¡ Lightning Nearby - Blitz-LightningTracker
description: Notify if lightning strikes within specified distance
use_blueprint:
  path: lightning_notification.yaml
triggers:
- entity_id: !input lightning_distance_sensor
  below: !input max_distance
  trigger: numeric_state
variables:
  input_only_notify_closer_strikes: !input only_notify_closer_strikes
  input_lightning_distance_sensor: !input lightning_distance_sensor
conditions:
- condition: template
  value_template: "{%- if not input_only_notify_closer_strikes -%}\n  true\n{%- else
    -%}\n  {%- set current_distance = states(input_lightning_distance_sensor) | float
    -%}\n  {%- set last_distance = states('input_number.lightning_last_distance')
    | float(999) -%}\n  {{ current_distance < last_distance }}\n{%- endif -%}\n"
actions:
- variables:
    input_lightning_distance_sensor: !input lightning_distance_sensor
    input_lightning_distance: '{{ states(input_lightning_distance_sensor) }}'
    input_lightning_area_sensor: !input lightning_area_sensor
    input_lightning_area:  '{{ states(input_lightning_area_sensor) }}'
    raw_device: !input notify_device
    input_notify_device: '{{ ''notify.mobile_app_'' ~ (device_attr(raw_device, ''name'')
      | string | lower | replace('' '', ''_'') | replace("''", '''') | replace("''",
      '''') | replace(''`'', '''') | replace(''"'', '''') | trim) }}'
    device_tracker_entity: '{{ device_entities(raw_device) | select(''match'', ''device_tracker'')
      | first }}'
    device_latitude: '{{ state_attr(device_tracker_entity, ''latitude'') }}'
    device_longitude: '{{ state_attr(device_tracker_entity, ''longitude'') }}'
    input_notification_title: !input notification_title
    input_notification_channel: !input notification_channel
    input_notification_timeout: !input notification_timeout
    input_google_maps_api_key: !input google_maps_api_key
    input_include_map_image: !input include_map_image
    input_show_device_location: !input show_device_location
    input_only_notify_closer_strikes: !input only_notify_closer_strikes
- action: '{{ input_notify_device }}'
  data:
    title: '{{ input_notification_title }}'
    message: 'Strike detected {{ input_lightning_distance }} km away in {{ input_lightning_area }}.

      '
    data:
      notification_icon: mdi:flash
      channel: '{{ input_notification_channel }}'
      timeout: '{{ input_notification_timeout * 60 | int }}'
      ttl: 0
      priority: high
      clickAction: https://maps.google.com/?q={{ state_attr(states('sensor.latest_lightning_strike_entity_id'),
        'latitude') }},{{ state_attr(states('sensor.latest_lightning_strike_entity_id'),
        'longitude') }}
      image: '{%- if input_include_map_image and input_google_maps_api_key != "" -%}
        https://maps.googleapis.com/maps/api/staticmap?zoom=auto&size=400x200 &markers=color:yellow%7Csize:mid%7C{{
        state_attr(states(''sensor.latest_lightning_strike_entity_id''), ''latitude'')
        }},{{ state_attr(states(''sensor.latest_lightning_strike_entity_id''), ''longitude'')
        }} {%- if input_show_device_location -%} &markers=color:blue%7Csize:mid%7C{{
        device_latitude }},{{ device_longitude }} {%- endif -%} &key={{ input_google_maps_api_key
        }} {%- endif -%}

        '
- service: input_number.set_value
  data:
    entity_id: input_number.lightning_last_distance
    value: '{{ (input_lightning_distance | float(default=5000)) }}'
- delay:
    minutes: !input cooldown_minutes
mode: single
